{# planning/matrix.html #}
{% extends "base.html" %}
{% load planning_tags %}

{% block title %}Crop Plan — {{ year }}{% endblock %}

{% block content %}
<div class="planning-header">
    <h1>{{ year.year }} Crop Plan</h1>
    <div class="week-nav">
        <a href="{% url 'planning:matrix_week' week_start|add:'-8' %}" 
           class="btn">← Earlier</a>
        <span>Weeks {{ week_start }}–{{ week_end }}</span>
        <a href="{% url 'planning:matrix_week' week_end|add:'1' %}" 
           class="btn">Later →</a>
        <a href="{% url 'planning:matrix' %}" class="btn">Today</a>
    </div>
</div>

{# Week header row #}
<div class="matrix-container">
    <table class="planning-matrix">
        <thead>
            <tr>
                <th class="block-col">Block</th>
                <th class="beds-col">Beds</th>
                {% for w in weeks %}
                <th class="week-col {% if w.is_current %}week-current{% endif %}">
                    <div class="week-num">{{ w.num }}</div>
                    <div class="week-date">{{ w.date|date:"M j" }}</div>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {# Field blocks section #}
            <tr class="section-header">
                <td colspan="{{ weeks|length|add:2 }}">Field Blocks</td>
            </tr>
            {% for block in field_blocks %}
                {% with rows=matrix|get_item:block.id %}
                {% if rows %}
                    {% for row in rows %}
                    <tr class="planting-row" data-block="{{ block.id }}">
                        {% if forloop.first %}
                        <td class="block-col" rowspan="{{ rows|length }}">
                            {{ block.name }}
                        </td>
                        {% endif %}
                        <td class="beds-col">
                            {{ row.sublabel }}
                        </td>
                        {% render_planting_bar row weeks %}
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr class="planting-row empty-block" data-block="{{ block.id }}">
                        <td class="block-col">{{ block.name }}</td>
                        <td class="beds-col">1-{{ block.num_beds }}</td>
                        {% for w in weeks %}
                        <td class="week-cell fallow"
                            data-block="{{ block.id }}" data-week="{{ w.num }}">
                        </td>
                        {% endfor %}
                    </tr>
                {% endif %}
                {% endwith %}
            {% endfor %}

            {# Tunnel blocks section #}
            <tr class="section-header">
                <td colspan="{{ weeks|length|add:2 }}">High Tunnels</td>
            </tr>
            {% for block in tunnel_blocks %}
                {% with rows=matrix|get_item:block.id %}
                {# Same pattern as field blocks #}
                {% if rows %}
                    {% for row in rows %}
                    <tr class="planting-row" data-block="{{ block.id }}">
                        {% if forloop.first %}
                        <td class="block-col" rowspan="{{ rows|length }}">
                            {{ block.name }}
                        </td>
                        {% endif %}
                        <td class="beds-col">{{ row.sublabel }}</td>
                        {% render_planting_bar row weeks %}
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr class="planting-row empty-block" data-block="{{ block.id }}">
                        <td class="block-col">{{ block.name }}</td>
                        <td class="beds-col">1-{{ block.num_beds }}</td>
                        {% for w in weeks %}
                        <td class="week-cell fallow"
                            data-block="{{ block.id }}" data-week="{{ w.num }}">
                        </td>
                        {% endfor %}
                    </tr>
                {% endif %}
                {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>

{# Planting detail panel — shown when clicking a planting bar #}
<div id="planting-detail" class="detail-panel" style="display:none;">
    {# Loaded via HTMX or JS #}
</div>
{% endblock %}

{# matrix.html, add HTMX to planting bars #}

{# Clicking a planting bar loads its detail into the side panel #}
<td class="week-cell planting-bar {{ css }}"
    colspan="{{ col_span }}"
    hx-get="{% url 'planning:planting_detail' planting.id %}"
    hx-target="#planting-detail"
    hx-swap="innerHTML"
    hx-trigger="click">
    <span class="planting-label">{{ row.label }}</span>
</td>

{# Clicking a fallow cell opens the new planting form, pre-filled #}
<td class="week-cell fallow"
    hx-get="{% url 'planning:planting_create_prefilled' block_id=block.id week=w.num %}"
    hx-target="#planting-detail"
    hx-swap="innerHTML"
    hx-trigger="click">
</td>
