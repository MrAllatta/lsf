{# operations/harvest_entry.html #}
{% extends "base.html" %}

{% block title %}Harvest Entry â€” Week {{ week_num }}{% endblock %}

{% block content %}
<div class="harvest-header">
    <h1>ğŸŒ¿ Harvest Entry â€” Week {{ week_num }}</h1>
    <div class="week-date">{{ week_monday|date:"l, F j, Y" }}</div>
    <div class="harvest-nav">
        <a href="{% url 'operations:harvest_entry_week' prev_week %}" class="btn">â† Wk {{ prev_week }}</a>
        <a href="{% url 'operations:harvest_entry_week' next_week %}" class="btn">Wk {{ next_week }} â†’</a>
    </div>
    <div class="harvest-progress">
        Recorded: {{ recorded }} / {{ total_items }} items
        Â· Est. {{ total_bins|floatformat:0 }} bins total
    </div>
</div>

<form method="post" id="harvest-form">
    {% csrf_token %}
    
    {% for block_name, items in blocks.items %}
    <div class="harvest-block">
        <h2>{{ block_name }}</h2>
        
        {% for item in items %}
        <div class="harvest-item {% if item.has_actual %}recorded{% endif %}"
             id="item-{{ item.event.id }}">
            <div class="harvest-item-header">
                <span class="crop-name">{{ item.crop_name }}</span>
                <span class="location">{{ item.block }} beds {{ item.beds }}</span>
                <span class="target">
                    Target: {{ item.target_qty|floatformat:0 }} {{ item.units }}
                    {% if item.target_bins %}
                    (â‰ˆ{{ item.target_bins|floatformat:1 }} {{ item.bin_type }})
                    {% endif %}
                </span>
            </div>
            
            <div class="harvest-item-entry">
                <label for="bins_{{ item.event.id }}">
                    {% if item.units_per_bin %}
                    {{ item.bin_type }}s:
                    {% else %}
                    {{ item.units }}:
                    {% endif %}
                </label>
                <input type="number" 
                       name="bins_{{ item.event.id }}"
                       id="bins_{{ item.event.id }}"
                       step="0.5"
                       value="{% if item.actual_bins %}{{ item.actual_bins }}{% endif %}"
                       class="bin-input"
                       {% if item.units_per_bin %}
                       data-units-per-bin="{{ item.units_per_bin }}"
                       {% endif %}>
                
                {% if item.units_per_bin %}
                <span class="converted-qty" id="qty_{{ item.event.id }}">
                    {% if item.actual_qty %}
                    = {{ item.actual_qty|floatformat:0 }} {{ item.units }}
                    {% endif %}
                </span>
                {% endif %}
                
                <input type="text"
                       name="notes_{{ item.event.id }}"
                       placeholder="notes..."
                       value="{{ item.event.notes }}"
                       class="notes-input">
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
    
    <div class="harvest-actions">
        <button type="submit" class="btn btn-primary btn-large">
            Save All ({{ total_items }} items)
        </button>
    </div>
</form>

<script>
// Live bin-to-quantity conversion
document.querySelectorAll('.bin-input').forEach(input => {
    input.addEventListener('input', function() {
        const unitsPerBin = this.dataset.unitsPerBin;
        if (unitsPerBin) {
            const qty = parseFloat(this.value || 0) * parseFloat(unitsPerBin);
            const qtyEl = document.getElementById('qty_' + this.name.replace('bins_', ''));
            if (qtyEl) {
                qtyEl.textContent = qty > 0 ? `= ${Math.round(qty)} ${this.closest('.harvest-item').querySelector('.target').textContent.split(' ').slice(-1)[0]}` : '';
            }
        }
    });
});
</script>
{% endblock %}
